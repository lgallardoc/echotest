# üöÄ EchoTest - Cliente TCP/IP para Pruebas ISO 8583

**EchoTest** es una herramienta profesional para pruebas de carga y rendimiento en sistemas ISO 8583, dise√±ada para evaluar la capacidad y latencia de servidores de procesamiento de transacciones financieras con compatibilidad completa para sistemas AS/400.

## ‚ú® Caracter√≠sticas Principales

- **üîó Conexiones Permanentes:** Pool de conexiones TCP persistentes para mejor rendimiento
- **üìä Reportes Detallados:** Reportes HTML con m√©tricas completas, gr√°ficos interactivos y vista lado a lado
- **üåê Informaci√≥n de Red:** Detalles de IP origen, puerto origen, IP destino y puerto destino
- **‚ö° Multi-threading:** Ejecuci√≥n paralela con m√∫ltiples hilos
- **üìà M√©tricas Avanzadas:** Tiempo de respuesta, throughput, latencia y tasa de √©xito
- **üîç Agrupamiento por Conexiones:** An√°lisis detallado por conexi√≥n permanente
- **‚ö†Ô∏è Validaciones Inteligentes:** Advertencias y recomendaciones de configuraci√≥n
- **üìù Logging Completo:** Logs detallados con diferentes niveles de verbosidad
- **üîß Compatibilidad AS/400:** Formato de mensajes 100% compatible con sistemas mainframe
- **üéØ Bitmaps Inteligentes:** Bitmap primario y secundario con validaci√≥n autom√°tica
- **üìã Vista Lado a Lado:** Request y response mostrados simult√°neamente en reportes

## üèóÔ∏è Arquitectura

### Componentes Principales

- **Cliente TCP Multi-hilo:** Ejecuta pruebas en paralelo
- **Pool de Conexiones:** Gestiona conexiones permanentes al servidor
- **Generador de Mensajes ISO 8583:** Crea mensajes de prueba est√°ndar compatibles con AS/400
- **Sistema de Reportes:** Genera reportes HTML con m√©tricas, gr√°ficos y vista lado a lado
- **Sistema de Logging:** Registra eventos y m√©tricas en archivos
- **Validaci√≥n de Bitmaps:** Verifica autom√°ticamente la estructura de mensajes

### Flujo de Trabajo

1. **Inicializaci√≥n:** Establece conexiones permanentes con el servidor
2. **Distribuci√≥n:** Divide las iteraciones entre hilos
3. **Ejecuci√≥n:** Env√≠a mensajes ISO 8583 por las conexiones disponibles
4. **M√©tricas:** Recopila tiempos de respuesta y estad√≠sticas
5. **Reporte:** Genera reporte HTML con an√°lisis detallado y vista lado a lado

## üöÄ Instalaci√≥n

### Prerrequisitos

- **Node.js 14+** (recomendado: Node.js 16+ para mejor rendimiento)
- npm o pnpm
- Servidor TCP/IP para pruebas

### Verificaci√≥n de Compatibilidad

```bash
# Verificar versi√≥n de Node.js
node --version

# Verificar que sea >= 14.0.0
# El proyecto est√° configurado para ser compatible con Node.js 14+
```

### Caracter√≠sticas Verificadas

‚úÖ **ES2018+ Features:**

- Promise.allSettled
- BigInt
- String.prototype.padStart
- Array.prototype.flat
- Object.entries

‚úÖ **Node.js Built-in Modules:**

- fs.promises
- util.promisify
- Buffer.from
- process.env

‚úÖ **JavaScript Moderno:**

- async/await
- Template literals
- Arrow functions
- Classes
- Destructuring
- Spread operator

### Configuraci√≥n de TypeScript

```json
{
  "compilerOptions": {
    "target": "ES2018",
    "module": "CommonJS",
    "lib": ["ES2018"]
  }
}
```

### Dependencias Compatibles

- **@types/node:** ^14.18.0
- **typescript:** ^4.9.0
- **winston:** ^3.8.2
- **dotenv:** ^16.0.3

## üõ†Ô∏è Instalaci√≥n

### Instalaci√≥n R√°pida

```bash
# Clonar el repositorio
git clone https://github.com/lgallardoc/echotest.git
cd echotest

# Instalar dependencias
npm install
# o
pnpm install

# Compilar TypeScript
npm run build
```

### Scripts de Instalaci√≥n

```bash
# Instalaci√≥n autom√°tica
./install.sh
```

## üìñ Uso

### Cliente

```bash
# Compilar y ejecutar
npm run build
node dist/tcp-client.js [opciones]

# O usar ts-node directamente
npx ts-node tcp-client.ts [opciones]

# O usar el script
./run-client.sh [opciones]
```

### Servidor

```bash
# Compilar y ejecutar
npm run build
node dist/tcp-server.js [opciones]

# O usar ts-node directamente
npx ts-node tcp-server.ts [opciones]

# O usar el script
./run-server.sh [opciones]
```

## ‚öôÔ∏è Opciones de Configuraci√≥n

### Cliente

- `--ip <ip>`: Direcci√≥n IP del servidor (default: 10.245.229.25)
- `--pt <puerto>`: Puerto del servidor (default: 6020)
- `--it <iteraciones>`: N√∫mero de iteraciones (default: 1)
- `--dl <delay>`: Delay entre iteraciones en ms (default: 0)
- `--th <hilos>`: N√∫mero de hilos para paralelizaci√≥n (default: 1)
- `--cn <n>`: N√∫mero de conexiones permanentes (default: 1)
- `--ct <ms>`: Timeout de conexi√≥n en ms (default: 3000)
- `--rt <ms>`: Timeout de respuesta en ms (default: 2000)
- `--help`: Mostrar ayuda

### Servidor

- `--pt <puerto>`: Puerto del servidor (default: 6020)
- `--th <hilos>`: N√∫mero de hilos del servidor (default: 4)
- `--help`: Mostrar ayuda

## üìä Caracter√≠sticas del Reporte

### Vista Lado a Lado

El reporte HTML ahora incluye una vista lado a lado que muestra:

- **Request (Izquierda):** Mensaje enviado con todos los campos y bitmaps
- **Response (Derecha):** Mensaje recibido con todos los campos y bitmaps
- **Comparaci√≥n Visual:** F√°cil identificaci√≥n de diferencias entre request y response

### Agrupamiento por Conexiones

- **Agrupamiento por Conexiones:** Los detalles se organizan por conexi√≥n permanente para facilitar el an√°lisis
- **Informaci√≥n de Red:** Cada conexi√≥n muestra IP origen, puerto origen, IP destino y puerto destino
- **Estad√≠sticas por Conexi√≥n:** Cada conexi√≥n muestra sus propias m√©tricas (tiempo promedio, tasa de √©xito, etc.)
- **Validaci√≥n de Configuraci√≥n:** Advertencias cuando el n√∫mero de hilos no coincide con el n√∫mero de conexiones

### M√©tricas Importantes

- **Tiempo total:** Duraci√≥n completa de la prueba
- **Throughput:** Mensajes por segundo
- **Latencia promedio:** Tiempo promedio de respuesta
- **Latencia m√≠n/m√°x:** Valores extremos de latencia
- **Tasa de √©xito:** Porcentaje de mensajes exitosos
- **Timeouts configurados:** Valores de timeout de conexi√≥n y respuesta

### Estructura del Reporte

1. **Resumen Ejecutivo:** M√©tricas generales y configuraci√≥n
2. **Gr√°ficos de Rendimiento:** Visualizaci√≥n de latencia y throughput
3. **Detalles por Conexi√≥n:** An√°lisis individual de cada conexi√≥n
4. **Vista Lado a Lado:** Request y response para cada iteraci√≥n
5. **Informaci√≥n de Red:** Detalles de conectividad

## üîß Configuraci√≥n del Servidor

### Servidor Local

```bash
# Iniciar servidor en puerto 6020
./run-server.sh --pt 6020

# Con m√∫ltiples hilos
./run-server.sh --pt 6020 --th 8
```

### Configuraci√≥n de Red

- **Puerto:** 6020 (configurable)
- **Protocolo:** TCP/IP
- **Mensajes:** ISO 8583 Echo Test (MTI 0800/0810)
- **Encoding:** ASCII

## üìà Ejemplos de Uso

### Configuraciones B√°sicas

#### 1. Prueba Simple

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 10
```

**Resultado:** 10 mensajes enviados secuencialmente

#### 2. Prueba con M√∫ltiples Hilos

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 100 --th 5
```

**Resultado:** 100 mensajes distribuidos entre 5 hilos

#### 3. Prueba con Conexiones Permanentes

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 500 --th 8 --cn 8
```

**Resultado:** 500 mensajes con 8 conexiones permanentes (configuraci√≥n √≥ptima 1:1)

### Configuraciones Avanzadas

#### 4. Prueba de Carga Alta

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 1000 --th 20 --cn 5
```

**Resultado:** 1000 mensajes con alta concurrencia

#### 5. Prueba con Delay

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 50 --dl 100
```

**Resultado:** 50 mensajes con 100ms de delay entre cada uno

#### 6. Prueba de Estabilidad

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 1000 --dl 50 --th 5
```

**Resultado:** Prueba de estabilidad con carga moderada

#### 7. Prueba con Timeouts Personalizados

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 100 --ct 5000 --rt 3000
```

**Resultado:** 100 mensajes con timeout de conexi√≥n de 5 segundos y timeout de respuesta de 3 segundos

#### 8. Prueba Multi-hilo con Delay

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 50 --th 2 --dl 250
```

**Resultado:** 50 iteraciones por cada uno de los 2 hilos con 250ms de delay entre iteraciones

## üîç Validaciones y Advertencias

### Configuraci√≥n √ìptima (1:1)

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 100 --th 5 --cn 5
```

**Mensaje:** `‚úÖ Configuraci√≥n √≥ptima: 5 conexi√≥n(es) para 5 hilos (1:1)`

### M√°s Conexiones que Hilos

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 100 --th 3 --cn 5
```

**Mensaje:** `‚ÑπÔ∏è INFO: Tienes 5 conexi√≥n(es) para 3 hilos. Las conexiones adicionales permitir√°n mejor rendimiento.`

### M√°s Hilos que Conexiones (Advertencia)

```bash
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 100 --th 5 --cn 3
```

**Mensaje:**

```
‚ö†Ô∏è ADVERTENCIA: Tienes 5 hilos pero solo 3 conexi√≥n(es). Algunos hilos tendr√°n que esperar a que las conexiones est√©n disponibles.
üí° Recomendaci√≥n: Usar --cn 5 para tener una conexi√≥n por hilo, o reducir --th a 3 para usar una conexi√≥n por hilo.
```

## üìä Interpretaci√≥n de Resultados

### M√©tricas Clave

- **Latencia < 10ms:** Excelente rendimiento
- **Latencia 10-50ms:** Buen rendimiento
- **Latencia 50-100ms:** Rendimiento aceptable
- **Latencia > 100ms:** Posible problema de red o servidor

### An√°lisis por Conexi√≥n

- **Rendimiento Individual:** Cada conexi√≥n muestra sus propias m√©tricas
- **Distribuci√≥n de Carga:** C√≥mo se distribuyen las transacciones
- **Problemas Espec√≠ficos:** Identificar conexiones problem√°ticas

### Reportes Generados

- **Reporte HTML:** `tmp/echotest_report_IP_PORT_TIMESTAMP.html`
- **Logs:** `log/echotest_TIMESTAMP.log`

## üõ†Ô∏è Desarrollo

### Estructura del Proyecto

```
echotest/
‚îú‚îÄ‚îÄ tcp-client.ts          # Cliente principal
‚îú‚îÄ‚îÄ tcp-server.ts          # Servidor de pruebas
‚îú‚îÄ‚îÄ iso8583-js.d.ts        # Definiciones TypeScript
‚îú‚îÄ‚îÄ dist/                  # C√≥digo compilado
‚îú‚îÄ‚îÄ tmp/                   # Reportes HTML
‚îú‚îÄ‚îÄ log/                   # Archivos de log
‚îú‚îÄ‚îÄ run-client.sh          # Script del cliente
‚îú‚îÄ‚îÄ run-server.sh          # Script del servidor
‚îú‚îÄ‚îÄ install.sh             # Script de instalaci√≥n
‚îú‚îÄ‚îÄ package.json           # Configuraci√≥n del proyecto
‚îú‚îÄ‚îÄ tsconfig.json          # Configuraci√≥n TypeScript
‚îî‚îÄ‚îÄ README.md              # Documentaci√≥n principal
```

### Comandos de Desarrollo

```bash
# Compilar TypeScript
npm run build

# Ejecutar tests
npm test

# Limpiar archivos generados
npm run clean

# Ejecutar con ts-node (desarrollo)
npx ts-node tcp-client.ts
```

## üîß Configuraci√≥n Avanzada

### Variables de Entorno

```bash
# Nivel de logging
LOG_LEVEL=debug|info|error

# Timeout de conexi√≥n
CONNECTION_TIMEOUT=30000
```

### Configuraci√≥n de Red

- **TCP Keep-Alive:** Habilitado por defecto
- **Timeout de Conexi√≥n:** 30 segundos
- **Reintentos:** No implementados (se puede agregar)

## üêõ Troubleshooting

### Problemas Comunes

#### Error: "ECONNREFUSED"

```bash
# Verificar que el servidor est√© ejecut√°ndose
./run-server.sh --pt 6020
```

#### Error: "Timeout"

```bash
# Reducir la carga o aumentar el timeout
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 10 --th 1
```

#### Error: "Connection pool exhausted"

```bash
# Aumentar el n√∫mero de conexiones
./run-client.sh --ip 127.0.0.1 --pt 6020 --it 100 --th 10 --cn 10
```

#### Reporte no se genera

```bash
# Verificar permisos de escritura
chmod +w tmp/ log/
```

## üîß Compatibilidad con AS/400

### ‚úÖ Formato de Mensajes Compatible

EchoTest genera mensajes ISO 8583 completamente compatibles con sistemas AS/400. Los mensajes siguen el formato est√°ndar utilizado en entornos mainframe:

#### **Estructura del Mensaje AS/400:**

```
00670800822000000800000004000000000000002506271755007447005132007447301
```

#### **An√°lisis del Formato:**

- **Longitud:** `0067` (103 bytes)
- **MTI:** `0800` (Network Management Request)
- **Bitmap Primario:** `8220000008000000` (bits 1, 7, 11, 37 encendidos)
- **Bitmap Secundario:** `0400000000000000` (bit 33 encendido para campo 70)
- **Campos:** 1, 7, 11, 37, 70

### üìä Campos ISO 8583 Soportados

| Campo  | Descripci√≥n                         | Longitud | Bitmap | Valor                    |
| ------ | ----------------------------------- | -------- | ------ | ------------------------ |
| **1**  | Secondary Bitmap                    | 16 chars | 1      | `0400000000000000`       |
| **7**  | Transmission Date & Time            | 10 chars | 7      | `MMDDhhmmss`             |
| **11** | Systems Trace Audit Number          | 6 chars  | 11     | `STAN`                   |
| **37** | Retrieval Reference Number          | 12 chars | 37     | `005132STAN`             |
| **39** | Response Code                       | 2 chars  | 39     | `00` (solo en respuesta) |
| **70** | Network Management Information Code | 3 chars  | 70     | `301`                    |

### üîç Comparaci√≥n de Formatos

#### **Mensaje Cliente EchoTest:**

```
00670800822000000800000004000000000000002506271755007447005132007447301
```

#### **Mensaje AS/400 Real:**

```
00670800822000000800000004000000000000000627175206337846517800337846301
```

**‚úÖ Coincidencias:**

- Longitud del mensaje: `0067` (103 bytes)
- Bitmap primario: `8220000008000000`
- Bitmap secundario: `0400000000000000`
- Estructura de campos: 1, 7, 11, 37, 70
- Formato de fecha/hora: `MMDDhhmmss`
- Campo 70: `301` (Echo Test)

### üõ†Ô∏è Configuraci√≥n T√©cnica

#### **Inicializaci√≥n de Estructura ISO8583:**

```typescript
iso.init([
  [1, { bitmap: 1, length: 16 }], // Secondary Bitmap (8 bytes en hex)
  [7, { bitmap: 7, length: 10 }], // Transmission Date & Time
  [11, { bitmap: 11, length: 6 }], // Systems Trace Audit Number
  [37, { bitmap: 37, length: 12 }], // Retrieval Reference Number
  [70, { bitmap: 70, length: 3 }], // Network Management Information Code
]);
```

#### **Configuraci√≥n de Bitmaps:**

- **Bitmap Primario:** `8220000008000000`

  - Bit 1: Secondary Bitmap presente
  - Bit 7: Transmission Date & Time
  - Bit 11: Systems Trace Audit Number
  - Bit 37: Retrieval Reference Number

- **Bitmap Secundario:** `0400000000000000`
  - Bit 33: Network Management Information Code (campo 70)

### üîß Filtrado Autom√°tico

El sistema incluye filtrado autom√°tico para eliminar campos no deseados:

- **Campo 67:** Eliminado autom√°ticamente (no presente en AS/400)
- **Campos vac√≠os:** Filtrados del resultado final
- **Validaci√≥n:** Solo campos con valores v√°lidos se incluyen

### üìà Logs de Compatibilidad

Los logs muestran la compatibilidad completa:

```
[DEBUG] Bitmap primario: 8220000008000000
[DEBUG] Bitmap secundario: 0400000000000000
[DEBUG] Campo 1 (Secondary Bitmap) presente: 0400000000000000
[DEBUG] Campo 70 presente con valor: 301
[DEBUG] ‚úÖ Campo 67 correctamente excluido de la estructura
```

### üéØ Casos de Uso AS/400

#### **1. Pruebas de Conectividad:**

```bash
./run-client.sh --ip 192.168.1.100 --pt 6020 --it 10
```

#### **2. Pruebas de Carga:**

```bash
./run-client.sh --ip 192.168.1.100 --pt 6020 --it 1000 --th 10 --cn 5
```

#### **3. Pruebas de Estabilidad:**

```bash
./run-client.sh --ip 192.168.1.100 --pt 6020 --it 10000 --dl 100 --th 5
```

### üîç Verificaci√≥n de Compatibilidad

Para verificar que los mensajes son compatibles con AS/400:

1. **Comparar longitudes:** Mensajes deben tener 103 bytes (0067)
2. **Verificar bitmaps:** Primario y secundario deben coincidir
3. **Validar campos:** Solo campos 1, 7, 11, 37, 70 deben estar presentes
4. **Revisar formato:** Fecha/hora en formato `MMDDhhmmss`

### üìã Troubleshooting AS/400

#### **Problema: Mensaje rechazado por AS/400**

```bash
# Verificar formato del mensaje
./run-client.sh --ip 192.168.1.100 --pt 6020 --it 1
# Revisar logs para confirmar formato correcto
```

#### **Problema: Campos faltantes**

```bash
# Verificar que todos los campos est√©n presentes
tail -50 log/echotest_*.log
# Buscar: "Campo 1", "Campo 7", "Campo 11", "Campo 37", "Campo 70"
```

#### **Problema: Bitmap incorrecto**

```bash
# Verificar bitmaps en logs
grep "Bitmap primario" log/echotest_*.log
grep "Bitmap secundario" log/echotest_*.log
```

## üîß Compatibilidad

### Versiones de Node.js Soportadas

EchoTest es compatible con **Node.js 14+** y versiones superiores. Se han realizado las siguientes configuraciones para garantizar la compatibilidad:

- **TypeScript Target:** ES2018 (compatible con Node.js 14+)
- **Dependencias:** Versiones compatibles con Node.js 14+
- **Caracter√≠sticas:** Uso de ES2018+ features soportadas

### Verificaci√≥n de Compatibilidad

```bash
# Verificar versi√≥n de Node.js
node --version

# Verificar que sea >= 14.0.0
```

## üìã Changelog

### v1.4.0 - Vista Lado a Lado y Mejoras en Reportes

- ‚úÖ **Vista lado a lado:** Request y response mostrados simult√°neamente en reportes HTML
- ‚úÖ **Mejoras en bitmaps:** Visualizaci√≥n mejorada de bitmap primario y secundario
- ‚úÖ **Ordenamiento de campos:** Campos organizados por importancia (bitmaps, tipo, campos)
- ‚úÖ **Eliminaci√≥n de secci√≥n de an√°lisis:** Simplificaci√≥n del reporte
- ‚úÖ **Mejoras en CSS:** Layout mejorado con CSS Grid para vista lado a lado
- ‚úÖ **Documentaci√≥n actualizada:** README completo con todas las nuevas funcionalidades

### v1.3.0 - Compatibilidad AS/400

- ‚úÖ **Compatibilidad completa con AS/400:** Mensajes ISO 8583 compatibles con sistemas mainframe
- ‚úÖ **Bitmap secundario:** Implementaci√≥n correcta del campo 1 (Secondary Bitmap)
- ‚úÖ **Estructura de campos:** Solo campos 1, 7, 11, 37, 70 (eliminaci√≥n autom√°tica de campo 67)
- ‚úÖ **Formato de mensaje:** Longitud 103 bytes (0067) con estructura AS/400 est√°ndar
- ‚úÖ **Logs mejorados:** Informaci√≥n detallada de bitmaps y campos
- ‚úÖ **Documentaci√≥n AS/400:** Gu√≠a completa de compatibilidad y troubleshooting
- ‚úÖ **Validaci√≥n de formato:** Verificaci√≥n autom√°tica de estructura de mensajes

### v1.2.0 - Timeouts Configurables

- ‚úÖ Agregar par√°metro `--ct` para timeout de conexi√≥n (default: 3000ms)
- ‚úÖ Agregar par√°metro `--rt` para timeout de respuesta (default: 2000ms)
- ‚úÖ Implementar timeout de respuesta en cada iteraci√≥n
- ‚úÖ Mejorar parsing de mensajes ISO 8583 para incluir todos los campos
- ‚úÖ Corregir visualizaci√≥n del campo 70 en reportes HTML
- ‚úÖ Actualizar documentaci√≥n con nuevos par√°metros

### v1.1.0 - Conexiones Permanentes

- ‚úÖ Agregar par√°metro `--cn` para conexiones permanentes
- ‚úÖ Implementar pool de conexiones persistentes
- ‚úÖ Agregar informaci√≥n de red en reportes
- ‚úÖ Agrupar detalles por conexi√≥n
- ‚úÖ Validaciones de configuraci√≥n
- ‚úÖ Mejorar documentaci√≥n

### v1.0.0 - Versi√≥n Inicial

- ‚úÖ Cliente TCP multi-hilo
- ‚úÖ Servidor TCP multi-hilo
- ‚úÖ Generaci√≥n de mensajes ISO 8583
- ‚úÖ Reportes HTML con gr√°ficos
- ‚úÖ Sistema de logging

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT.

## ü§ù Contribuciones

Las contribuciones son bienvenidas. Por favor, abre un issue o pull request.

---

**Nota**: Este sistema est√° dise√±ado espec√≠ficamente para pruebas de Echo Test ISO 8583. Para uso en producci√≥n, considere implementar medidas de seguridad adicionales.
